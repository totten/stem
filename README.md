# stem: CiviCRM Standalone Enhancement Machine

`stem` will spin-up a developmental instance of CiviCRM.

`stem` is a lightweight edition of `civicrm-buildkit`. It (mostly) uses the same services and tools, but it only supports a subset of functionality.
It requires the `nix` package manager, which is compatible with Linux, MacOS, and Windows-WSL2.

## Quick start

| # | Step | Typical Commands |
| -- | -- | -- |
| 1.0 | Install `nix` package manager (*[more documentation](https://nixos.org/download)*) | `sh <(curl -L https://nixos.org/nix/install)` |
| 1.1 | Close and reopen your shell | |
| 1.2<br/><br/> | Enable binary downloads <br/><br/> | `nix-env -iA cachix -f https://cachix.org/api/v1/install` <br/> `cachix use bknix` |
| 2.0<br/><br/>   | Clone the project <br/><br/> | `git clone "https://FIXME"` <br/> `cd stem` |
| 3.0 | Review service options | `nano env.yml` |
| 3.1<br/><br/> | Start services (*On first run, this will auto-download necessary files.*) | `./bin/stem start` <br/><br/> |
| 4.0 | Install CiviCRM (*database and data files*) | `./bin/stem install` |

This should ultimately display some key information, such as:

```javascript
    "cmsBaseUrl": "http://civicrm.127.0.0.1.nip.io:8000",
    ...
    "extras": {
        "adminUser": "admin",
        "adminPass": "admin",
```

You will find all the major files and folders:

* `./web/core/`: Source code for CiviCRM
* `./web/upload/`: Public data-files uploaded by users
* `./data/`: Data-files generated by CiviCRM

To access CLI tools (such as `cv` or `civix`), you may open a shell:

```
./bin/stem shell
```

## Appendix: Buildkit version

This project uses `civicrm-buildkit.git` (as per `./nix/buildkit.nix`). To update to the latest version:

* Stop services. Close shells.
* Run: `./tools/update.sh`
* Start services.

## Appendix: Commands

`stem` is a small wrapper for other commands.

Some commands are simple aliases:

| Stem Command    | Real Command   |
| --              | --             |
| `stem shell`    | `cd $STEM_HOME && nix-shell`    |
| `stem start`    | `cd $STEM_HOME && loco start`   |
| `stem stop`     | `cd $STEM_HOME && loco stop`    |
| `stem status`   | `cd $STEM_HOME && loco status`  |
| `stem clean`    | `cd $STEM_HOME && loco clean`   |

A few commands are work-a-likes:

| Stem Command     | Comparable Command   |
| --               | --             |
| `stem create`    | `civibuild create NAME --type standalone-dev`   |
| `stem download`  | `civibuild download NAME --type standalone-dev` |
| `stem install`   | `civibuild install NAME --type standalone-dev`  |

## Meta

* Should probably mention configuring PATH (`PATH=$HOME/src/stem/bin:$PATH`). It's bog-standard, but bog-standard is always annoying to write-up (`.profile`, `.bashrc`, `.bash_profile`, `.zshrc`, ad nauseum).
  And it's not really necessary. (Once you open "./bin/stem shell" or `nix-shell`, the `PATH` will include everything.)
* Should probably talk about launching PHPStorm inside of `stem shell`.
* Should probably publish the Docker container. See 'nix/docker.nix' for steps to build. But documenting it means more complexity for reader. Also, it's a big download and fixing that is annoying.
* Should probably document the relative pros/cons vs civicrm-buildkit/nix/install-developer:
    * Pro: Simple `nix-shell` semantics. Doesn't require a "profile installation" phase. Fewer moving parts.
    * Pro: Simpler file structure. Civi code easier to reach.
    * Pro: `nix/profile.nix` is more hackable. (TODO: Update in-file comments with more examples of this...)
    * Pro: Don't have to choose profile everytime you open shell
    * Mixed: Defaults to MySQL on persistent storage (rather than ramdisk)
    * Con: `nix-shell` opens slower than `use-bknix`.
    * Con: `nix-shell` may not always open when offline. (*Need to test to see if that's still an issue these days*)
    * Con: Harder to flip between multiple PHP versions
    * Con: Configuring PHPStorm to use phpunit is probably more annoying
    * Con: Don't have access to civibuild or CMS build-types
    * Con: Weaker caching
    * Con: Can't replay jenkins jobs locally
