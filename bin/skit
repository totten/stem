#!/usr/bin/env bash
{ # https://stackoverflow.com/a/21100710
  set -e

  ACTION="$1"

  function absdirname() {
    pushd $(dirname $0) >> /dev/null
      pwd
    popd >> /dev/null
  }

  ## Re-launch if nix-shell (if necessary). Ensure we're in home.
  if [ -z "$SKIT_HOME" ]; then
    BINDIR=$(absdirname "$0")
    SKIT_HOME=$(dirname "$BINDIR")
    cd "$SKIT_HOME"
    case "$ACTION" in
      shell)
        exec nix-shell
        ;;
      *)
        exec nix-shell --command "./bin/skit $@"
        ;;
    esac
  fi
  cd "$SKIT_HOME"

  #################################################################################
  function show_help() {
    echo "[33mAbout:[0m"
    echo "  skit will start and stop civicrm standalone"
    echo
    echo "[33mService Management (MySQL, PHP, etc):[0m"
    echo "  skit start         Start services in background"
    echo "  skit stop          Stop services in background"
    echo "  skit status        Summarize the status of services"
    echo "  skit clean         Stop services. Destoy any data from MySQL."
    echo
    echo "[33mSite Management (CiviCRM) :[0m"
    echo "  skit create        Download and install CiviCRM"
    echo "  skit download      Download CiviCRM"
    echo "  skit install       Install CiviCRM (database and config files)"
    echo
    echo "[33mInteraction:[0m"
    echo "  skit shell         Open a shell"
    echo
    echo "[33mTIP:[0m"
    echo "  Skit is a thin wrapper for nix-shell and loco. If you need more functionality,"
    echo "  consider using those tools directly."
  }

  #################################################################################
  ## OK, we're in nix-shell.
  case "$ACTION" in

    start|stop|status|clean)
      loco "$@"
      ;;

    download|install|create)
      echo "TODO: $ACTION"
      ;;
      
    help)
      show_help
      ;;

    shell)
      echo >&2 "Already running in skit shell!"
      ;;

    *)
      echo >&2 "Unrecognized action: $ACTION"
      show_help >&2
      exit 1
      ;;

  esac

  exit # https://stackoverflow.com/a/21100710
}
